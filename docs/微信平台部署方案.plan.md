---
name: 微信平台部署方案
overview: 为 SAP 顾问需求网站配置微信服务号、小程序和 H5 网站，实现消息推送、支付功能和多渠道分享
todos:
  - id: apply-miniprogram
    content: 申请微信小程序账号，获取 AppID（个人或企业均可，企业账号支持支付功能）
    status: pending
  - id: config-miniprogram-appid
    content: 在 src/manifest.json 中配置小程序 AppID
    status: pending
    dependencies:
      - apply-miniprogram
  - id: config-cloudbase-domains
    content: 在微信公众平台和 CloudBase 控制台配置安全域名
    status: pending
    dependencies:
      - apply-miniprogram
  - id: create-wechat-config
    content: 创建 src/utils/wechat-config.ts 文件，存储服务号配置信息
    status: pending
  - id: create-daily-push-cloud-function
    content: 创建每日定时推送云函数 cloudfunctions/daily-demand-push/index.js，实现每天推送最近3天的SAP需求
    status: pending
    dependencies:
      - create-wechat-config
  - id: create-demand-query-utils
    content: 创建需求查询工具 cloudfunctions/daily-demand-push/utils/demand-query.js，封装最近3天需求查询和格式化逻辑
    status: pending
    dependencies:
      - create-daily-push-cloud-function
  - id: create-timer-trigger
    content: 配置云函数定时触发器，每天上午9:00自动执行推送任务
    status: pending
    dependencies:
      - create-daily-push-cloud-function
  - id: create-message-utils
    content: 创建 src/utils/wechat-message.ts 工具函数，封装消息推送功能（群发消息、模板消息等）
    status: pending
    dependencies:
      - create-daily-push-cloud-function
  - id: integrate-message-push
    content: 在需求发布和评论回复时集成消息推送功能（可选功能）
    status: pending
    dependencies:
      - create-message-utils
  - id: create-pay-cloud-function
    content: 创建支付云函数 cloudfunctions/wechat-pay/index.js（预留）
    status: pending
  - id: create-pay-utils
    content: 创建 src/utils/wechat-pay.ts 工具函数，封装支付功能（预留）
    status: pending
    dependencies:
      - create-pay-cloud-function
  - id: create-recharge-page
    content: 创建积分充值页面 src/pages/payment/recharge.vue（预留）
    status: pending
    dependencies:
      - create-pay-utils
  - id: optimize-share-miniprogram
    content: 优化小程序分享功能，添加 onShareAppMessage 和 onShareTimeline
    status: pending
    dependencies:
      - config-miniprogram-appid
  - id: optimize-share-h5
    content: 优化 H5 分享功能，集成微信 JS-SDK
    status: pending
  - id: deploy-h5
    content: 构建并部署 H5 版本到 CloudBase 静态网站托管
    status: pending
  - id: apply-wechat-account
    content: 申请微信公众号（订阅号，个人可申请，用于每日推送）
    status: pending
  - id: get-wechat-credentials
    content: 获取公众号 AppID 和 AppSecret（从公众号后台 -> 开发 -> 基本配置）
    status: pending
    dependencies:
      - apply-wechat-account
  - id: deploy-h5-for-link
    content: 部署 H5 网站到 CloudBase 静态网站托管，获取网站地址用于消息链接
    status: pending
  - id: link-miniprogram-service
    content: 在服务号后台关联小程序，配置菜单栏
    status: pending
    dependencies:
      - apply-service-account
      - apply-miniprogram
---

# 微信平台部署方案

## 一、分阶段实施计划

### 第一阶段：微信公众号每日推送（当前阶段）

**目标**：实现每天自动推送最近3天的SAP需求，消息中包含网站链接

**账号选择**：**订阅号**（个人可申请，每天可推送1条消息，完全满足需求）

**功能特点**：

- ✅ 每天定时推送（上午9:00，可配置）
- ✅ 推送最近3天的SAP需求汇总
- ✅ 消息中可以包含网站链接（H5链接）
- ✅ 支持图文消息格式，包含封面图和摘要
- ✅ 用户点击链接可直接打开网站

### 关于链接的说明

**微信公众号消息中可以包含链接**：

1. **图文消息**：

   - 可以设置"原文链接"，用户点击"阅读原文"可跳转到网站
   - 可以在消息正文中直接插入链接（部分情况下）
   - 推荐使用图文消息格式，包含封面图、标题、摘要和原文链接

2. **链接格式**：

   - 支持 HTTP/HTTPS 链接
   - 链接需要是已备案的域名（或使用 CloudBase 提供的域名）
   - 链接可以在微信内打开（H5页面）

3. **最佳实践**：

   - 使用图文消息格式
   - 设置吸引人的封面图和标题
   - 在摘要中简要说明内容
   - 设置"原文链接"指向你的H5网站

### 后续阶段（暂不实施）

- 第二阶段：小程序开发
- 第三阶段：支付功能
- 第四阶段：分享功能优化

## 二、账号申请和配置步骤

### 阶段1：账号申请（需要你手动完成）

#### 1.1 申请微信公众号（第一阶段）

- **申请地址**：https://mp.weixin.qq.com/
- **账号类型**：选择**订阅号**（个人可申请，免费）
- **申请原因**：
  - 每天可推送1条消息（完全满足每日推送需求）
  - 个人可申请，无需企业资质
  - 免费使用
  - 支持图文消息，可以包含网站链接
- **申请流程**：
  1. 访问 https://mp.weixin.qq.com/
  2. 注册微信公众平台账号
  3. 选择账号类型为"订阅号"
  4. 填写基本信息：
     - 账号名称（如：SAP顾问需求平台）
     - 账号简介（如：每日推送最新SAP顾问需求信息）
     - 头像（建议使用专业Logo）
  5. 等待审核（通常 1-3 个工作日）
- **重要信息获取**：
  - 登录公众号后台
  - 开发 -> 基本配置
  - 获取 **AppID** 和 **AppSecret**（用于调用微信 API）
  - 记录这些信息，后续配置需要用到

#### 1.2 申请微信小程序

- **申请地址**：https://mp.weixin.qq.com/
- **账号类型**：选择"小程序"
- **认证要求**：
  - 个人：可以申请，但功能受限（不支持支付）
  - 企业：需要认证才能使用支付功能
  - 认证费用：300元/年
- **申请流程**：

  1. 注册小程序账号
  2. 填写基本信息
  3. 获取 AppID（重要！）
  4. 如需支付功能，进行微信认证

#### 1.3 关联服务号和小程序

- 在服务号后台：开发 -> 开发管理 -> 小程序管理 -> 关联小程序
- 输入小程序的 AppID，完成关联
- 关联后可以在服务号菜单栏中添加小程序入口

### 阶段2：项目配置（代码实现）

#### 2.1 配置小程序 AppID

**文件**：`src/manifest.json`

需要在小程序配置中添加 AppID：

```json
"mp-weixin": {
    "appid": "你的小程序AppID",
    "setting": {
        "urlCheck": false
    },
    "usingComponents": true
}
```

#### 2.2 配置微信公众号 AppID 和 Secret

**新建文件**：`src/utils/wechat-config.ts`

用于存储公众号配置信息（用于消息推送）：

```typescript
// 微信公众号配置（订阅号）
export const WECHAT_MP_CONFIG = {
  appId: '你的公众号AppID',        // 从公众号后台获取
  appSecret: '你的公众号AppSecret', // 从公众号后台获取
  // 注意：订阅号不需要 token 和 encodingAESKey（除非需要接收用户消息）
};
```

**配置位置**：

- 公众号后台 -> 开发 -> 基本配置
- AppID：应用ID
- AppSecret：应用密钥（需要点击"生成"按钮生成）

**安全提示**：

- AppSecret 是敏感信息，不要提交到代码仓库
- 建议使用环境变量或 CloudBase 环境变量存储
- 在云函数中使用环境变量读取配置

#### 2.3 配置 CloudBase 安全域名

**需要配置的域名**：

- 小程序：在微信公众平台 -> 开发 -> 开发管理 -> 开发设置 -> 服务器域名中配置
  - request 合法域名：`https://tcb-api.tencentcloudapi.com`
  - uploadFile 合法域名：`https://cos.ap-shanghai.myqcloud.com`
  - downloadFile 合法域名：`https://cloud1-2g93n7qgab878d25.tcb.qcloud.la`
- 服务号：在云开发控制台 -> 环境配置 -> 安全来源 -> 安全域名中配置

### 阶段3：消息推送功能实现

#### 3.1 创建定时推送云函数（核心功能）

**新建文件**：`cloudfunctions/daily-demand-push/index.js`

实现每天自动推送最近3天的SAP需求：

- 使用 CloudBase 定时触发器（每天执行一次）
- 查询最近3天的需求数据（从 `sap_demands_raw` 集合）
- 格式化消息内容（标题、摘要、链接等）
- 调用微信公众号群发消息 API
- 记录推送日志（成功/失败）

**定时触发器配置**：

- 触发时间：每天上午 9:00（可配置）
- Cron 表达式：`0 0 9 * * *`（秒 分 时 日 月 周）

#### 3.2 创建消息推送工具函数

**新建文件**：`src/utils/wechat-message.ts`

封装消息推送相关功能：

- `sendMassMessage()` - 发送群发消息（用于每日推送）
- `sendTemplateMessage()` - 发送模板消息（新需求通知、评论回复通知等）
- `sendCustomerMessage()` - 发送客服消息（用户咨询回复）
- `subscribeMessage()` - 订阅消息（小程序）
- `getAccessToken()` - 获取微信 Access Token（用于调用 API）

#### 3.3 创建需求数据查询工具

**新建文件**：`cloudfunctions/daily-demand-push/utils/demand-query.js`

封装需求数据查询逻辑：

- `getRecentDemands()` - 查询最近3天的需求
- `formatDemandMessage()` - 格式化需求为消息内容
- `groupDemandsByModule()` - 按模块分组需求（可选）

#### 3.4 集成到业务逻辑

**修改文件**：

- `src/pages/demand/detail.vue` - 新需求发布时触发推送（可选）
- `src/pages/demand/detail.vue` - 评论回复时触发推送（可选）

**注意**：每日定时推送是主要功能，实时推送是可选功能

### 阶段4：支付功能预留

#### 4.1 创建支付云函数

**新建文件**：`cloudfunctions/wechat-pay/index.js`

实现微信支付功能：

- 统一下单接口
- 支付回调处理
- 积分充值逻辑

#### 4.2 创建支付工具函数

**新建文件**：`src/utils/wechat-pay.ts`

封装支付相关功能：

- `createPayment()` - 创建支付订单
- `checkPaymentStatus()` - 查询支付状态
- `handlePaymentCallback()` - 处理支付回调

#### 4.3 创建积分充值页面

**新建文件**：`src/pages/payment/recharge.vue`

积分充值界面：

- 选择充值金额
- 调用支付接口
- 支付成功后更新用户积分

### 阶段5：分享功能优化

#### 5.1 小程序分享配置

**修改文件**：`src/pages/demand/demand.vue`、`src/pages/demand/detail.vue`

添加分享功能：

- `onShareAppMessage()` - 分享给微信好友
- `onShareTimeline()` - 分享到朋友圈
- 自定义分享标题、图片、路径

#### 5.2 H5 分享配置

**修改文件**：`index.html`

添加微信分享 SDK：

- 引入微信 JS-SDK
- 配置分享标题、描述、图片
- 支持分享到微信好友和朋友圈

#### 5.3 服务号菜单栏配置

在服务号后台配置自定义菜单：

- 菜单1：需求广场（跳转小程序）
- 菜单2：我的（跳转小程序个人中心）
- 菜单3：关于（跳转 H5 页面或小程序）

### 阶段6：H5 网站部署

#### 6.1 构建 H5 版本

使用 CloudBase 静态网站托管：

```bash
npm run build:h5
```

#### 6.2 部署到 CloudBase

使用 CloudBase CLI 或 MCP 工具部署：

- 上传 `dist/build/h5` 目录到静态网站托管
- 配置自定义域名（可选）

#### 6.3 配置微信 JS-SDK

在 H5 页面中引入微信 JS-SDK，实现：

- 分享功能
- 微信登录
- 支付功能（如需要）

## 三、技术实现细节

### 3.1 消息推送实现方案

**每日定时推送流程**（核心功能）：

```
定时触发器（每天 9:00）
  → 触发云函数 daily-demand-push
  → 查询最近3天的需求数据（sap_demands_raw 集合）
  → 格式化消息内容（标题、摘要、链接）
  → 获取微信 Access Token
  → 调用微信公众号群发消息 API
  → 发送给所有关注用户
  → 记录推送日志
```

**消息内容格式**（图文消息）：

**标题**：SAP 顾问需求日报 - 2024-12-18

**封面图**：使用项目Logo或相关图片

**摘要**：最近3天新增 X 条SAP顾问需求，涵盖FICO、MM、SD等多个模块...

**正文内容**：

```
📋 最近3天新增需求汇总：

1. 【FICO模块】上海 - 6个月
   需要5年以上FICO经验，熟悉财务模块...
   
2. 【MM模块】远程 - 3个月
   需要3年以上MM经验，英语流利...
   
3. 【SD模块】北京 - 长期
   需要8年以上SD经验，有制造业背景...
   
...（最多显示10条，按时间倒序）

点击"阅读原文"查看完整需求列表和详情
```

**原文链接**：设置为你的H5网站地址（如：`https://your-domain.com/demand`）

**技术要点**：

- 使用微信公众号的"群发消息"接口（订阅号每天限1次）
- 使用**图文消息**格式，支持封面图、标题、摘要和原文链接
- 原文链接可以指向H5网站，用户点击可直接打开
- 消息内容需要符合微信规范（避免敏感词、特殊字符等）
- 定时触发器使用 CloudBase 的定时触发器功能
- 建议在消息中添加"点击阅读原文查看完整列表"的提示

**模板消息推送流程**（可选功能）：

```
用户操作（发布需求/评论） 
  → 触发云函数 
  → 调用微信公众平台 API 
  → 发送模板消息给关注用户
```

**订阅消息推送流程**（小程序）：

```
用户授权订阅消息 
  → 用户操作触发 
  → 调用云函数发送订阅消息
```

### 3.2 支付功能实现方案

**支付流程**：

```
用户选择充值金额 
  → 调用云函数创建订单 
  → 返回支付参数 
  → 调用微信支付 API 
  → 支付成功后回调云函数 
  → 更新用户积分
```

### 3.3 分享功能实现方案

**小程序分享**：

- 使用 UniApp 的 `onShareAppMessage` 生命周期
- 自定义分享卡片（标题、图片、路径）

**H5 分享**：

- 使用微信 JS-SDK 的 `updateAppMessageShareData` 和 `updateTimelineShareData`
- 需要服务号配置 JS 接口安全域名

## 四、注意事项

1. **认证要求**：

   - 服务号必须认证才能使用支付功能
   - 小程序必须认证才能使用支付功能
   - 个人账号无法申请服务号，只能申请订阅号

2. **开发环境**：

   - 小程序开发需要使用微信开发者工具
   - 服务号开发需要配置服务器 URL（用于接收消息）
   - H5 开发需要配置 JS 接口安全域名

3. **测试环境**：

   - 小程序可以在微信开发者工具中测试
   - 服务号消息推送需要在真机上测试
   - 支付功能需要在真机上测试（开发环境无法测试支付）

4. **成本考虑**：

   - 服务号认证：300元/年
   - 小程序认证：300元/年（如需支付功能）
   - 云开发费用：按实际使用量计费

## 五、实施优先级

### 第一阶段优先级（当前实施）

#### 必须完成（核心功能）

1. ✅ 申请微信公众号（订阅号）
2. ✅ 获取 AppID 和 AppSecret
3. ✅ 部署 H5 网站（用于消息中的链接）
4. ✅ 创建每日定时推送云函数
5. ✅ 配置定时触发器（每天9:00）
6. ✅ 测试推送功能

#### 可选功能（后续优化）

1. 优化消息格式和内容
2. 添加推送日志记录
3. 添加错误处理和重试机制

### 后续阶段（暂不实施）

- 第二阶段：小程序开发
- 第三阶段：支付功能
- 第四阶段：分享功能优化

## 六、下一步行动

## 七、第一阶段实施步骤

### 步骤1：申请微信公众号（你需要完成）

1. 访问 https://mp.weixin.qq.com/
2. 注册并选择"订阅号"
3. 填写基本信息
4. 等待审核通过
5. 获取 AppID 和 AppSecret

### 步骤2：部署 H5 网站（用于消息链接）

1. 构建 H5 版本：`npm run build:h5`
2. 部署到 CloudBase 静态网站托管
3. 获取网站访问地址（如：`https://your-env-id.tcb.qcloud.la`）

### 步骤3：配置和实现（我来完成）

1. 创建配置文件 `src/utils/wechat-config.ts`
2. 创建每日推送云函数 `cloudfunctions/daily-demand-push/index.js`
3. 创建需求查询工具 `cloudfunctions/daily-demand-push/utils/demand-query.js`
4. 配置定时触发器（每天9:00执行）
5. 测试推送功能

### 步骤4：提供配置信息（你需要提供）

完成步骤1后，请提供以下信息：

- 公众号 AppID
- 公众号 AppSecret
- H5 网站地址（用于消息中的链接）

我会帮你配置到项目中并完成代码实现。





























